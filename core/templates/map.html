{% load static %}
<!DOCTYPE html>
<!--[if IE 7]>
<html class="ie ie7" lang="en-US" prefix="og: http://ogp.me/ns#">
<![endif]-->
<!--[if IE 8]>
<html class="ie ie8" lang="en-US" prefix="og: http://ogp.me/ns#">
<![endif]-->
<!--[if !(IE 7) | !(IE 8) ]><!-->
<html lang="en-US" prefix="og: http://ogp.me/ns#">
<!--<![endif]-->
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
        <meta name="description" content="{{ ORGANIZATION_SETTINGS.description }}">
        <meta property="og:image" content="{{ ORGANIZATION_SETTINGS.og_url }}"/>
        <meta property="og:url" content="{{ ORGANIZATION_SETTINGS.organization_url }}"/>
        <meta property="og:title" content="{{ ORGANIZATION_SETTINGS.og_title }}"/>
        <meta property="og:description" content="{{ ORGANIZATION_SETTINGS.description }}"/>

        <link href="//api.tiles.mapbox.com/mapbox.js/v2.1.9/mapbox.css" rel="stylesheet"/>

        <meta property="og:title" content="{{ ORGANIZATION_SETTINGS.og_title }}" />
        <meta property="og:url" content="{{ ORGANIZATION_SETTINGS.og_url }}" />
        <meta property="og:image" content="{% static "img/pe-og.png" %}" />
        <meta property="og:description" content="{{ ORGANIZATION_SETTINGS.og_description }}" />

        <meta name="twitter:card" content="{{ ORGANIZATION_SETTINGS.twitter_card }}">
        <meta name="twitter:site" content="{{ ORGANIZATION_SETTINGS.twitter_site }}">
        <meta name="twitter:creator" content="{{ ORGANIZATION_SETTINGS.twitter_creator }}">
        <meta name="twitter:title" content="{{ ORGANIZATION_SETTINGS.twitter_title }}">
        <meta name="twitter:description" content="{{ ORGANIZATION_SETTINGS.twitter_description }}">
        <meta name="twitter:image" content="{{ ORGANIZATION_SETTINGS.twitter_image }}">

        <link rel="stylesheet" type="text/css" href="{% static 'css/events-map.css' %}">
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Merriweather:400,900,700"/>
        <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:100,900,700,400,300"/>
    </head>

    <title>{{ ORGANIZATION_SETTINGS.name }} Events</title>

    <body class="list-view initial-view">
    <section id="header">
        <div id="header" class="lato">
            <div class="main-title-area">
                <div style="margin-bottom: 4px;">
                    <div id='spiel'>
                        <strong>{{ ORGANIZATION_SETTINGS.name }} Events</strong><br>
                        Find the nearest volunteer activity or meeting near you.
                    </div>
                </div>
            </div>

            <nav>
                <ul id="nav">
                    <li>
                        <a href="//twitter.com/share" class="twitter-share-button"
                           data-url="{{ ORGANIZATION_SETTINGS.events_url }}"
                           data-text="I'm going to an event for {{ ORGANIZATION_SETTINGS.name }}! Find events near you!"
                           data-count="none">Tweet</a>
                        <div class="fb-share-button"
                             data-href="{{ ORGANIZATION_SETTINGS.site_url }}"
                             data-layout="button">
                            <a href="javascript:fbShare('{{ ORGANIZATION_SETTINGS.site_url }}', 'Fb Share', 'Facebook share popup', '{{ ORGANIZATION_SETTINGS.twitter_image }}', 520, 350)">
                                <img src="{% static 'img/icon/fb.png' %}"/><span>Share</span></a>
                        </div>
                    </li>
                    <li>
                        <a href="" class="contribute contribute-big" target="_blank">Host an Event</a>
                    </li>
                </ul>
            </nav>
            <div style="clear: both"></div>
        </div>
    </section>
    <section id='activity-area' class='clearfix'>
        <article id='events'>
            <div id='filters'>
                <div id='loading-icon' class='lato'>Loading...</div>
                <h3 id='switch-link'>
                    <a href='javascript: void(null)' onclick='window.mapManager.toMapView()' id='to-map-view'>Show Map</a>
                    <a href='javascript: void(null)' onclick='window.mapManager.toListView()' id='to-list-view'>Show
                        List</a>
                </h3>
                <h4 class='lato title'>
                    <span id='screen-title'>Filters</span>
                    <span id='mobile-title'>Volunteer for {{ ORGANIZATION_SETTINGS.name }}</span>
                </h4>
                <form id='filter-form'>
                    <table>
                        <tr>
                            <td>
                                <h5 class='lato'>By Zipcode</h5>
                                <input type='number' name='zipcode' maxlength='5' placeholder='ZIPCODE'
                                       onclick="this.select();">
                            </td>
                            <td>
                                <h5 class='lato'>Distance</h5>
                                <select name='distance'>
                                    <option value='5'>5mi</option>
                                    <option value='20'>20mi</option>
                                    <option value='50' selected='selected'>50mi</option>
                                    <option value='100'>100mi</option>
                                </select>
                            </td>
                            <td>
                                <h5 class='lato'>Sort By</h5>
                                <select name='sort'>
                                    <option value='time' selected='selected'>Time</option>
                                    <option value='distance'>Distance</option>
                                </select>
                                <input type='button' style='position: absolute; z-index: -1; opacity: 0;'
                                       id='hidden-button'/>
                            </td>
                        </tr>
                    </table>
                    <div id='filter-popup-area' class='lato'>
                        <a href='javascript: void(null)' class='filter-button show-filter'
                           onclick='$("#events").addClass("show-type-filter");'>
                            Search by Event
                        </a>
                        <div id='filter-list-area'>
                            <h5>Search by Event</h5>
                            <div id='f-container'>
                                <div id='filter-list-container'>
                                    <ul id='filter-list'></ul>
                                </div>
                                <div style='text-align: center; font-size: 11px; margin-top: 10px; color: lightgray;'>
                                    <a href='javascript: void(null)' id='show-all'
                                       onclick='$("#filter-list").find("input[type=checkbox]").prop("checked", true).trigger("change");'>Show
                                        All</a> &bull;
                                    <a href='javascript: void(null)'
                                       onclick='$("#filter-list").find("input[type=checkbox]").prop("checked", false).trigger("change")'>Hide
                                        All</a>
                                </div>
                            </div>
                            <p align='right'>
                                <a href='javascript: void(null)' class='filter-button'
                                   onclick='$("#events").removeClass("show-type-filter");'>
                                    Hide Legend
                                </a>
                            </p>
                        </div>
                    </div>
                </form>
            </div>
            <div id='event-list-container'>
                <div id='hide-show-office' data-count="0">
                    <a href='javascript: void(null)' class='contribute-big show-office'
                       onclick='$("body").addClass("show-office")'>
                        <span class='show-offices'>&#8882; Show Nearby Offices (<span
                                id='campaign-off-count'></span>)</span>
                    </a>
                    <a href='javascript: void(null);' class='contribute-big hide-office'
                       onclick='$("body").removeClass("show-office")'>
                        <span class='hide-offices'>&#8883; Hide Offices</span>
                    </a>
                </div>
                <ul id='event-list'>
                    <li class='mobile-only lato'>Please type in your <strong>zipcode</strong> to view nearby events.
                    </li>
                </ul>
                <footer>
                    <div id='footer-area'>
                        <h5>{{ ORGANIZATION_SETTINGS.name }}</h5>
                        <h5>{{ ORGANIZATION_SETTINGS.address }}</h5>
                        <h5>{{ ORGANIZATION_SETTINGS.city }}, {{ ORGANIZATION_SETTINGS.state }} {{ ORGANIZATION_SETTINGS.zip }}</h5>

                        <div id='paid-for-bernie-box'>
                            Paid for By {{ ORGANIZATION_SETTINGS.name }}
                        </div>
{#                        <div id='footer-billionaire' style="margin-bottom: 30px;">#}
{#                            <svg width="200" height="40">#}
{#                                <image xlink:href="{% static 'img/billionaires.svg' %}" width="200" height="40" x="0"/>#}
{#                            </svg>#}
{#                        </div>#}
                        <sub>
                            Copyright &copy; {{ COPYRIGHT_YEAR }}
                            <a href="{{ ORGANIZATION_SETTINGS.organization_url }}">{{ ORGANIZATION_SETTINGS.name }}</a>
                        </sub>
                    </div>
                </footer>
            </div>
        </article>
        <article id='map'>
            <div id='map-container'></div>
        </article>
    </section>
    <section id='campaign-offices'>
        <div class='viewport'>
            <h3 class='title'>Nearby Campaign Offices</h3>
            <a class='close-button lato' href='javascript: void(null);' onclick='$("body").removeClass("show-office")'>x</a>
            <div class='container'>
                <ul id='campaign-office-list'></ul>
            </div>
        </div>
    </section>

    <!-- JQUERY -->
    <script src="//code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/4.9.1/d3.min.js"></script>
    <script id='zipcodes-datadump' type='text/plain'></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.4/js.cookie.min.js"></script>
    <script src="{% static 'js/deparam.min.js' %}"></script>
    <script src="{% static 'js/mapbox.min.js' %}"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <script src="{% static 'js/MapManager.js' %}"></script>
    <script>
        window.eventTypeFilters = [
            // {
            //   name: 'Campaign Office',
            //   id: 'campaign-office',
            //   onItem: "<img style='width: 14px; height: 14px;' src='//d1y0otadi3knf6.cloudfront.net/img/icon/star.png' />",
            //   offItem: "<img style='width: 14px; height: 14px;' src='//d1y0otadi3knf6.cloudfront.net/img/icon/star-gray.png' />"
            // },
            // { name: 'GOTV Center',
            //   id: 'gotv-center',
            //   onItem: "<img style='width: 14px; height: 14px;' src='//d1y0otadi3knf6.cloudfront.net/img/icon/gotv-star.png' />",
            //   offItem: "<img style='width: 14px; height: 14px;' src='//d1y0otadi3knf6.cloudfront.net/img/icon/star-gray.png' />"
            // },
            // {
            //   name: 'Bernie Event',
            //   id: 'bernie-event',
            //   onItem: "<span class='map-red-circle'></span>",
            // },
            // {
            //   name: 'Healthcare Rally',
            //   id: 'feb-25th',
            //   onItem: "<span class='map-red-circle'></span>",
            // },
            // {
            //   name: 'State of the Revolution Livestream',
            //   id: 'state-of-the-revolution-livestream',
            //   onItem: "<span class='map-red-circle'></span>"
            // },
            {
                name: 'Official Event',
                id: 'official-event',
                onItem: "<span class='map-red-circle'></span>"
            },
            {
                name: 'Phonebank',
                id: 'phonebank'
            },
            {
                name: 'Canvassing',
                id: 'canvassing'
            },
            {
                name: 'Volunteer Activity',
                id: 'volunteer'
            },
            {
                name: 'Party Meetings',
                id: 'party-meetings'
            },
            // {
            //   name: 'Carpool',
            //   id: 'carpool'
            // },
            // {
            //   name: 'Register Voters',
            //   id: 'register-voters'
            // },
            // {
            //   name: 'Barnstorm',
            //   id: 'barnstorm'
            // },
            {
                name: 'Other',
                id: 'other'
            }
        ];
    </script>

    <script>
        (function ($, d3) {
            var date = new Date();
            $("#loading-icon").show();
            $.ajax({
                url: "{% static 'd/event-data.js' %}",
                dataType: 'script',
                cache: true, // otherwise will get fresh copy every page load
                success: function (data) {
                    d3.csv("{% static 'd/campaign-offices.csv' %}",
                        function (campaignOffices) {
                            //Load zipcodes
                            d3.csv("{% static 'd/us_postal_codes.csv' %}",
                                function (zipcodes) {
                                    $("#loading-icon").hide();
                                    //Clean data
                                    window.EVENT_DATA.results.forEach(function (d) {
                                        d.filters = [];
                                        //Set filter info
                                        switch (d.event_type_name) {
                                            case "Phone Bank" :
                                                d.filters.push("phonebank");
                                                break;
                                            case "Canvass for Our Revolution" :
                                                d.filters.push("canvassing");
                                                break;
                                            case "Volunteer Activity or Meeting" :
                                                d.filters.push("volunteer");
                                                break;
                                            case "Party Meetings" :
                                                d.filters.push("party-meetings");
                                                break;
                                            default:
                                                d.filters.push('other');
                                                break;
                                        }

                                        d.is_official = d.is_official == "1";
                                        if (d.is_official) {
                                            d.filters.push("official-event");
                                        }
                                    });

                                    var oldDate = new Date();

                                    window.EVENT_DATA.results = window.EVENT_DATA.results.concat(
                                        campaignOffices.map(function (d) {
                                            return {
                                                filters: d.type == 'office' ? ["campaign-office"] : ["gotv-center"],
                                                url: "https://maps.google.com?saddr=Current+Location&daddr=" + encodeURIComponent(d.address),
                                                longitude: d.lon,
                                                latitude: d.lat,
                                                name: d.name,
                                                location: d.address,
                                                event_type_name: d.type == 'office' ? "Campaign Office" : "GOTV Center",
                                                capacity: 0,
                                                id_obfuscated: d.address,
                                                phone: d.phone,
                                                is_official: false,
                                                image: d.type == 'office' ? d.photo : null,
                                                is_campaign_office: d.type == 'office',
                                                is_gotv_center: d.type == 'gotv',
                                                opening_event: d.opening_event == "" ? null : d.opening_event
                                            };
                                        })
                                    );

                                    /* Extract default lat lon */
                                    var m = /.*\?c=(.+?),(.+?),(\d+)z#?.*/g.exec(window.location.href)
                                    if (m && m[1] && m[2] && m[3]) {
                                        var defaultCoord = {
                                            center: [parseFloat(m[1]), parseFloat(m[2])],
                                            zoom: parseInt(m[3])
                                        };
                                        window.mapManager = MapManager(window.EVENT_DATA.results, campaignOffices, zipcodes, {defaultCoord: defaultCoord});
                                        var params = $.deparam
                                        window.mapManager.filterByCoords(defaultCoord.center, 50, params.sort, params.f);
                                    } else {
                                        window.mapManager = MapManager(window.EVENT_DATA.results, campaignOffices, zipcodes);
                                    }

                                    if ($("input[name='zipcode']").val() == '' && Cookies.get('map.bernie.zipcode') && window.location.hash == '') {
                                        $("input[name='zipcode']").val(Cookies.get('map.bernie.zipcode'));
                                        window.location.hash = $("#filter-form").serialize();
                                    } else {
                                        $(window).trigger("hashchange");
                                    }
                                });
                        }
                    );
                }, error: function (a, b, c) {
                    console.log("ERROR", b, c);
                }
            });

            // Registration Data items
            d3.csv("{% static 'd/registration-data.csv' %}", function (votinginfo) {
                window.votingInfoManager = VotingInfoManager(votinginfo);
            });

            /** initial loading before activating listeners...
             */

            var params = $.deparam(window.location.hash.substring(1));
            if (params.zipcode) {
                $("input[name='zipcode']").val(params.zipcode);
            }

            if (params.distance) {
                $("select[name='distance']").val(params.distance);
            }
            if (params.sort) {
                $("select[name='sort']").val(params.sort);
            }

            /* Prepare filters */
            $("#filter-list").append(
                window.eventTypeFilters.map(function (d) {
                    return $("<li />")
                        .append(
                            $("<input type='checkbox' class='filter-type' />")
                                .attr('name', 'f[]')
                                .attr("value", d.id)
                                .attr("id", d.id)
                                .prop("checked", !params.f ? true : $.inArray(d.id, params.f) >= 0)
                        )
                        .append($("<label />").attr('for', d.id).append($("<span />").addClass('filter-on')
                            .append(d.onItem ? d.onItem : $("<span>").addClass('circle-button default-on')))
                            .append($("<span />").addClass('filter-off')
                                .append(d.offItem ? d.offItem : $("<span>").addClass('circle-button default-off')))
                            .append($("<span>").text(d.name)));
                })
            );
            /***
             *  define events
             */
            //only numbers
            $("input[name='zipcode']").on('keyup keydown', function (e) {
                if (e.type == 'keydown' && (e.keyCode < 48 || e.keyCode > 57)
                    && e.keyCode != 8 && !(e.keyCode >= 37 || e.keyCode <= 40)) {
                    return false;
                }

                if (e.type == 'keyup' && $(this).val().length == 5) {
                    if (!(e.keyCode >= 37 && e.keyCode <= 40)) {
                        $(this).closest("form#filter-form").submit();
                        $("#hidden-button").focus();
                    }
                }
            });

            /***
             *  onchange of select
             */
            $("select[name='distance'],select[name='sort']").on('change', function (e) {
                $(this).closest("form#filter-form").submit();
            });

            /**
             * On filter type change
             */
            $(".filter-type").on('change', function (e) {
                $(this).closest("form#filter-form").submit();
            })

            //On submit
            $("form#filter-form").on('submit', function (e) {
                var serial = $(this).serialize();
                window.location.hash = serial;
                e.preventDefault();
                return false;
            });

            $(window).on('hashchange', function (e) {

                var hash = window.location.hash;
                if (hash.length == 0 || hash.substring(1) == 0) {
                    $("#loading-icon").hide();
                    return false;
                }

                var params = $.deparam(hash.substring(1));

                //Custom feature for specific default lat/lon
                //lat=40.7415479&lon=-73.8239609&zoom=17

                setTimeout(function () {
                    $("#loading-icon").show();

                    if (window.mapManager._options && window.mapManager._options.defaultCoord && params.zipcode.length != 5) {
                        window.mapManager.filterByType(params.f);
                        window.mapManager.filterByCoords(window.mapManager._options.defaultCoord.center, params.distance, params.sort, params.f);
                    } else {
                        window.mapManager.filterByType(params.f);
                        window.mapManager.filter(params.zipcode, params.distance, params.sort, params.f);
                    }
                    $("#loading-icon").hide();

                    var $info = window.votingInfoManager.getInfo(window.mapManager._zipcodes[params.zipcode].state);
                    $(".registration-msg").remove();
                    if ($info) {
                        $info.prependTo("#event-list-container");
                    }

                }, 10);
                // $("#loading-icon").hide();
                if (params.zipcode.length == 5 && $("body").hasClass("initial-view")) {
                    $("#events").removeClass("show-type-filter");
                    $("body").removeClass("initial-view");
                }
            });

            var pre = $.deparam(window.location.hash.substring(1));
            if ($("body").hasClass("initial-view")) {
                if ($(window).width() >= 600 && (!pre.zipcode || pre && pre.zipcode.length != 5)) {
                    $("#events").addClass("show-type-filter");
                }
            }

            // $('input#state-of-the-revolution-livestream').parent().css('width','100%');

        })(jQuery, d3);
    </script>

    <!-- SOCIAL -->
    <script>
        !function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
            if (!d.getElementById(id)) {
                js = d.createElement(s);
                js.id = id;
                js.src = p + '://platform.twitter.com/widgets.js';
                fjs.parentNode.insertBefore(js, fjs);
            }
        }(document, 'script', 'twitter-wjs');
    </script>
    </body>
    <script>
        function fbShare(url, title, descr, image, winWidth, winHeight) {
            var winTop = (screen.height / 2) - (winHeight / 2);
            var winLeft = (screen.width / 2) - (winWidth / 2);
            window.open('http://www.facebook.com/sharer.php?s=100&p[title]=' + title + '&p[summary]=' + descr + '&p[url]=' + url + '&p[images][0]=' + image, 'sharer', 'top=' + winTop + ',left=' + winLeft + ',toolbar=0,status=0,width=' + winWidth + ',height=' + winHeight);
        }
    </script>
</html>
